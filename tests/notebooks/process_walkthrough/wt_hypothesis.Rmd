---
title: "Walkthrough - Hypothesis Extraction"
author: "Evan Canfield"
date: "12/30/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Import
## Libraries
```{r import_libraries}
  if (!require(pacman)) {install.packages('pacman')}
  p_load(
    dplyr
  )
```

## Assisting Functions
```{r}
#' Inspect Text String
inspect <- function(x, m = 100, span = 20) {
  n = m + span - 1
  x[m:n]
}
```

## Regex
```{r}
regex_hypo_marker <- "<split>hypo (.*?):"
```

## Data
```{r}
folder_path <- "./../../../inst/extdata/sample_documents/"
pdf_paths <- list.files(recursive = FALSE, 
                       path = folder_path, 
                       pattern = ".pdf", 
                       full.names = TRUE)
print(pdf_paths)
```
# Preceding Steps
## Process Text
```{r}
n = 10
input_path <- pdf_paths[n]
input_path
cat("\n\n")
input_text <- process_text(input_path)

inspect(input_text, m = 215, span = 20)
```

# Extract Hypothesis
## Identify lines with hypothesis pattern
```{r}
# Identify lines with hypothesis pattern
h_match <- input_text %>%
  stringr::str_match(
    pattern = regex_hypo_marker
  )

# h_match
```


## Extract hypothesis number
```{r}
h_match_num <- h_match[,2]

h_match_num
```

### Inspect
```{r}
inspect(input_text, m = 186, span = 10)
```

## Identify unique hypothesis numbers
```{r}
# Identify unique hypothesis numbers
h_match_num_unq <- unique(h_match_num)

h_match_num_unq

# Remove known erroneous hypothesis formats
error_hypothesis <- c("na")

h_match_num_unq <- setdiff(h_match_num_unq, error_hypothesis)

# Drop NA
h_match_num_unq <- h_match_num_unq[!is.na(h_match_num_unq)]

h_match_num_unq
```

#### Reduce to unique hypothesis
Drop 4 if 4a was already identified.

```{r}
  hypothesis_labels <- h_match_num_unq
  
  # hypothesis_labels <- c("1", "2a", "2b", "3a", "4", "2", "3", "3b", "1b")  
  # hypothesis_labels

  # Check if hypothesis label contains letters
  hypothesis_labels_alpha <- grepl("[a-zA-Z]", hypothesis_labels)
  # hypothesis_labels_alpha
  
  # Extract Numbers
  regex_return_num <- "(\\d)+"

  hypothesis_numbers <- stringr::str_extract(
    string = hypothesis_labels,
    pattern = regex_return_num
  )

  h_num_output <- c()
  h_label_output <- c()
  
  # hypothesis_labels_alpha <- hypothesis_labels_alpha[1:3]

  for (i in seq_along(hypothesis_labels_alpha)) {
    
    h_label_alpha <- hypothesis_labels_alpha[i]
    h_num <- hypothesis_numbers[i]
    h_label <- hypothesis_labels[i]
 
    # If label contains a letter
    if (h_label_alpha) {
      
      # Check if number already used in label
      if (!(h_num %in% h_label_output)) {
        
        h_label_output <- c(h_label_output, h_label)
        h_num_output <- c(h_num_output, h_num)
      
        }
      
    } else {
      
      if (!(h_num %in% h_num_output)) {
        
        h_label_output <- c(h_label_output, h_label)
        h_num_output <- c(h_num_output, h_num)
      
        }
    }
  }
  h_num_output
  h_label_output

  stringr::str_sort(x = h_label_output)
  
```

```{r}
h_match_num_unq <- unique_hypothesis_labels(h_match_num_unq)
h_match_num_unq
```

## Drop Empty Hypothesis Lines
```{r}
# Drop Hypothesis lines with hypothesis tag only
h_match_num <- drop_empty_hypothesis(
  hypothesis_index        = h_match_num,
  unique_hypothesis_label = h_match_num_unq,
  input_text              = input_text
  )

h_match_num
```


## Determine Vector Index of Initial Hypthesis Instance
```{r}
# Determine vector index of initial hypothesis statements
h_initial <- c()
for (i in h_match_num_unq){
  intial_idx <- tapply(seq_along(h_match_num),
                       h_match_num,
                       min)[i]
  h_initial <- c(h_initial, intial_idx)
}

# Reduce text to only initial hypothesis instances
h_statements <- input_text[h_initial]
h_statements
```

## Split Statements on Hypothesis Indicator
```{r}
# Split Statements On Indicator (Defined in Processing) ------------------------
## Define
split_indicator <- "<split>"

## Split on indicator
h_statements <- stringr::str_split(
  string  = h_statements,
  pattern = split_indicator) %>%
  unlist()

## Detect statements which contain "Hypo"
logical_hypothesis_2 <- stringr::str_detect(
  string  = h_statements,
  pattern = "hypo"
)

## Drop Statements that Do Not Include "Hypo"
h_statements <- h_statements[logical_hypothesis_2]

h_statements
```

## Drop Duplicate Hypothesis Calls
```{r}
 # Drop Duplicate Hypothesis Calls --------------------------------------------
## Extract hypothesis number
h_id <- h_statements %>%
  stringr::str_extract("hypo (.*?):") %>%
  stringr::str_remove_all("hypo ") %>%
  stringr::str_remove_all(":") 

h_id

## Identify Duplicate Hypothesis Numbers
logical_hypothesis_3 <- vector(
  mode   = "logical",
  length = length(h_id)
)

h_tracker <- vector(
  mode   = "integer",
  length = length(h_id)
)

for (i in seq_along(h_id)) {
  num <- h_id[i]

  if (is.na(num)){
    logical_hypothesis_3[i] = FALSE
    h_tracker[i] <- -1

  } else if (num %in% h_tracker) {
    logical_hypothesis_3[i] = FALSE
    h_tracker[i] <- -1

  } else {
    logical_hypothesis_3[i] = TRUE
    h_tracker[i] <- num

  }
}

## Drop duplicates and non-hypotheses
h_statements <- h_statements[logical_hypothesis_3]

h_statements
```


## Extract Hypothesis Numbers after possible duplicates dropped
```{r}
h_id <- h_statements %>%
  stringr::str_extract("hypo (.*?):") %>%
  stringr::str_remove_all("hypo ") %>%
  stringr::str_remove_all(":") 

h_id
```


## Create Output Dataframe Columns
```{r}
# Save current state for causality classification input
hypothesis_causality <- h_statements

# Drop ~Hypo #:~ for entity extraction input
hypothesis_entity <- gsub(".*: ","", h_statements)
```

## Apply Fasttext Model

```{r}
apply_model = FALSE

# Filter with hypothesis classification model
if (apply_model) {

  # Verify hypothesis statements are available
  if (!(purrr::is_empty(hypothesis_entity))) {

    output_hypothesis <- apply_fasttext(
      hypothesis_entity,
      hypothesis_causality
    )

    hypothesis_causality <- output_hypothesis[[1]]
    hypothesis_entity <- output_hypothesis[[2]]

  }
}
```

## Create Output Dataframe
```{r}

# Create Dataframe with hypothesis number and hypothesis
df_hypothesis <- data.frame(
  h_id,
  hypothesis_entity,
  hypothesis_causality,
  stringsAsFactors = FALSE
)

df_hypothesis
```

## Modify Output Dataframe
```{r}
  # Rename and add Hypothesis Number
  df_hypothesis <- df_hypothesis %>%
    dplyr::rename(
      hypothesis = hypothesis_entity
    ) %>%
    dplyr::mutate(
      h_id = paste0("h_", h_id)
    ) %>%
    dplyr::select(h_id, hypothesis, hypothesis_causality)

  df_hypothesis
```

